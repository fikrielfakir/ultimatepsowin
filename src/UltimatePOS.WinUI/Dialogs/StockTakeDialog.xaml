<?xml version="1.0" encoding="utf-8"?>
<ContentDialog
    x:Class="UltimatePOS.WinUI.Dialogs.StockTakeDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:UltimatePOS.WinUI.Dialogs"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:UltimatePOS.Core.ViewModels.Stock"
    xmlns:converters="using:UltimatePOS.WinUI.Converters"
    xmlns:ctWinUI="using:CommunityToolkit.WinUI.UI.Controls"
    mc:Ignorable="d"
    Title="Stock Take / Physical Inventory"
    PrimaryButtonText="Complete Stock Take"
    SecondaryButtonText="Save Progress"
    CloseButtonText="Close"
    DefaultButton="Primary"
    Style="{StaticResource DefaultContentDialogStyle}">

    <ContentDialog.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
    </ContentDialog.Resources>

    <Grid MinWidth="900" MinHeight="650">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Stock Take Header Info -->
        <StackPanel Grid.Row="0" Spacing="8" Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Spacing="4">
                    <TextBlock Style="{StaticResource SubtitleTextBlockStyle}">
                        <Run Text="Stock Take #"/>
                        <Run Text="{x:Bind ViewModel.StockTake.Id, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock Style="{StaticResource BodyTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}">
                        <Run Text="Location: "/>
                        <Run Text="{x:Bind ViewModel.SelectedLocation.Name, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <InfoBadge x:Name="StatusBadge"/>
                    <Button Command="{x:Bind ViewModel.RefreshCommand}" 
                            ToolTipService.ToolTip="Refresh data"
                            Visibility="{x:Bind ViewModel.IsReadOnly, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <FontIcon Glyph="&#xE72C;" FontSize="14"/>
                    </Button>
                </StackPanel>
            </Grid>

            <InfoBar Severity="Informational" IsOpen="True" IsClosable="False"
                     Visibility="{x:Bind ViewModel.IsReadOnly, Mode=OneWay, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                <InfoBar.Message>
                    Count each product's physical inventory and enter the counted quantity. Variance will be automatically calculated.
                </InfoBar.Message>
            </InfoBar>

            <InfoBar Severity="Warning" IsOpen="True" IsClosable="False"
                     Visibility="{x:Bind ViewModel.IsReadOnly, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
                <InfoBar.Message>
                    This stock take has been completed and is now read-only.
                </InfoBar.Message>
            </InfoBar>
        </StackPanel>

        <!-- Notes Section -->
        <TextBox Grid.Row="1" 
                 Header="Notes" 
                 Text="{x:Bind ViewModel.StockTake.Notes, Mode=TwoWay}"
                 PlaceholderText="Add notes about this stock take..."
                 IsReadOnly="{x:Bind ViewModel.IsReadOnly, Mode=OneWay}"
                 AcceptsReturn="True"
                 TextWrapping="Wrap"
                 MaxHeight="80"
                 Margin="0,0,0,16"/>

        <!-- Details DataGrid -->
        <Grid Grid.Row="2">
            <ctWinUI:DataGrid ItemsSource="{x:Bind ViewModel.Details, Mode=OneWay}"
                              AutoGenerateColumns="False"
                              GridLinesVisibility="Horizontal"
                              BorderThickness="1"
                              BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                              CornerRadius="4">
                <ctWinUI:DataGrid.Columns>
                    <ctWinUI:DataGridTextColumn Header="Product" 
                                                Binding="{Binding ProductName}" 
                                                Width="*"
                                                IsReadOnly="True"/>
                    <ctWinUI:DataGridTextColumn Header="SKU" 
                                                Binding="{Binding ProductSKU}" 
                                                Width="120"
                                                IsReadOnly="True"/>
                    <ctWinUI:DataGridTextColumn Header="Expected" 
                                                Binding="{Binding ExpectedQuantity}" 
                                                Width="100"
                                                IsReadOnly="True"/>
                    <ctWinUI:DataGridTemplateColumn Header="Counted" Width="120">
                        <ctWinUI:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <NumberBox Value="{Binding CountedQuantity, Mode=TwoWay}" 
                                           SpinButtonPlacementMode="Inline"
                                           Minimum="0"
                                           ValueChanged="OnCountedQuantityChanged"
                                           HorizontalAlignment="Stretch"
                                           Margin="4,0"/>
                            </DataTemplate>
                        </ctWinUI:DataGridTemplateColumn.CellTemplate>
                    </ctWinUI:DataGridTemplateColumn>
                    <ctWinUI:DataGridTextColumn Header="Variance" 
                                                Binding="{Binding Variance}" 
                                                Width="100"
                                                IsReadOnly="True"/>
                    <ctWinUI:DataGridTemplateColumn Header="Notes" Width="200">
                        <ctWinUI:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBox Text="{Binding Notes, Mode=TwoWay}" 
                                         PlaceholderText="Add notes..."
                                         BorderThickness="0"
                                         Background="Transparent"/>
                            </DataTemplate>
                        </ctWinUI:DataGridTemplateColumn.CellTemplate>
                    </ctWinUI:DataGridTemplateColumn>
                </ctWinUI:DataGrid.Columns>
            </ctWinUI:DataGrid>

            <!-- Loading Indicator -->
            <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                          Width="50" Height="50"
                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </Grid>

        <!-- Footer with Auto-Adjust Option -->
        <StackPanel Grid.Row="3" Margin="0,16,0,0" Spacing="12"
                    Visibility="{x:Bind ViewModel.IsReadOnly, Mode=OneWay, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
            <CheckBox x:Name="AutoAdjustCheckBox" 
                      Content="Automatically adjust stock levels to match counted quantities"
                      IsChecked="True"/>
            <TextBlock Style="{StaticResource CaptionTextBlockStyle}" 
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                       TextWrapping="Wrap">
                If enabled, stock levels will be automatically updated to match your counts. Otherwise, variances will be recorded but stock levels won't change.
            </TextBlock>
        </StackPanel>
    </Grid>
</ContentDialog>
